<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live GPS Tracking (VietMap)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Inter', Arial, sans-serif;
            background: #f5f7fb;
        }
        #map {
            width: 100vw; height: 100vh;
        }
        .leaflet-popup-content { font-size: 1.1em; }
        .floating-group {
            position: fixed; left: 22px; top: 20px; z-index: 1001;
            display: flex; flex-direction: column; gap: 14px;
        }
        .status-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.99);
            padding: 10px 22px;
            border-radius: 15px;
            box-shadow: 0 2px 12px #0002;
            font-size: 1.04em;
            font-weight: 500;
            min-width: 240px;
            transition: box-shadow 0.18s, border 0.18s;
            border: 1.2px solid #e9e9ee;
        }
        .status-icon {
            font-size: 1.21em;
        }
        .connected .status-icon { color: #16a085; }
        .disconnected .status-icon { color: #e74c3c; }
        .status-box#coords .status-icon { color: #0072bb; }
        .status-box#last-update .status-icon { color: #f4a300; }
        .control-btn {
            border:none; outline:none;
            border-radius:15px;
            padding:11px 22px;
            font-size:1em;
            background:#3175c3;
            color:#fff;
            cursor:pointer;
            margin-bottom:0;
            box-shadow: 0 2px 12px #0001;
            transition: background 0.18s, box-shadow 0.18s;
            font-weight:500;
        }
        .control-btn:hover, .control-btn:focus {
            background: #185fa4;
            box-shadow: 0 4px 18px #0002;
        }
        .control-btn.active, .control-btn:active {
            background: #11c882 !important;
            color: #fff;
        }
        .vietmap-logo {
            position: fixed;
            bottom: 18px; right: 22px;
            z-index: 1002;
            opacity: 0.77;
        }
        .vietmap-logo img { height:36px; }
        @media (max-width:600px) {
            .floating-group { left: 7px; top: 8px; gap: 10px; }
            .status-box, .control-btn { min-width: 145px; padding:7px 12px; font-size:0.98em;}
            .vietmap-logo img { height:28px;}
        }
        #webrtc-modal {
            display:none; position:fixed; inset:0; background:#0009; z-index:3000;
            align-items:center; justify-content:center;
        }
        .modal-content {
            background:#fff; 
            border-radius:12px; 
            width:min(92vw, 960px); 
            padding:10px;
            max-height: 90vh;
            overflow: auto;
        }
        .modal-header {
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            gap:12px; 
            margin-bottom:8px;
        }
        .video-container {
            width:100%; 
            aspect-ratio:16/9; 
            background:#000;
            position: relative;
        }
        #wrtc-canvas {
            width:100%; 
            height:100%; 
            display:block;
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <!-- Floating status & controls group -->
    <div class="floating-group">
        <div id="status" class="status-box connected">
            <span class="status-icon">&#9989;</span>
            <span id="status-text">Connecting...</span>
        </div>
        <div id="last-update" class="status-box">
            <span class="status-icon">&#128337;</span>
            <span id="update-text">Latest update: No data</span>
        </div>
        <div id="coords" class="status-box">
            <span class="status-icon">&#128205;</span>
            <span id="coords-text">Lat: --- , Lon: ---</span>
        </div>
        <button id="clear-history" class="control-btn">Clear history</button>
        <button id="follow-marker" class="control-btn active">Update current position</button>
    </div>
    <!-- Map -->
    <div id="map"></div>
    <!-- Logo VietMap -->
    <div class="vietmap-logo">
        <img src="https://maps.vietmap.vn/images/logo_vietmap.png" alt="VietMap Logo"/>
    </div>

    <!-- Modal WebRTC (canvas) -->
    <div id="webrtc-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 style="margin:8px 0;">Live Camera üìπ</h3>
          <button id="close-wrtc" class="control-btn" style="background:#e74c3c;">‚úñ ƒê√≥ng</button>
        </div>
        <div class="video-container">
          <canvas id="wrtc-canvas"></canvas>
          <div id="loading-overlay" class="loading-overlay">
            ƒêang t·∫£i camera...
          </div>
        </div>
      </div>
    </div>

    <script>
        const RELAY_HOST = window.location.hostname;
        const RELAY_PORT = '9000';
        const scriptSrc = `${window.location.protocol}//${RELAY_HOST}:${RELAY_PORT}/static/rtsp-relay.js`;
        const script = document.createElement('script');
        script.src = scriptSrc;
        script.onerror = function() {
            console.error('Not download rtsp-relay.js from:', scriptSrc);
            alert('Error: Disconnect to server camera. Checking:\n1. Server Node.js is running?\n2. Port 9000 is openning?\n3. IP/hostname is correct?');
        };
        document.head.appendChild(script);
        window.loadPlayer = window.loadPlayer || function(){ 
            alert("Error: Don't load to rtsp-relay.js. Server camera not run!"); 
        };
    </script>
    
    <script>
        var vietmapApiKey = "2eada1a08ba9a656491f1e14cc0224ee5ea4d611c8adae41";
        var map = L.map('map').setView([21.028511, 105.804817], 13);

        var tileLayer = L.tileLayer(
            `https://maps.vietmap.vn/maps/tiles/tm/{z}/{x}/{y}@2x.png?apikey=${vietmapApiKey}`,
            { attribution: '¬© VietMap.vn', maxZoom: 18 }
        ).addTo(map);

        var xeIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
            iconSize: [44, 44],
            iconAnchor: [22, 44],
            popupAnchor: [0, -32]
        });

        var marker = null;
        var latlngs = [];
        var polyline = null;
        var autoFollow = true;
        var statusDiv = document.getElementById('status');
        var statusText = document.getElementById('status-text');
        var lastUpdateDiv = document.getElementById('last-update');
        var updateText = document.getElementById('update-text');
        var coordsDiv = document.getElementById('coords');
        var coordsText = document.getElementById('coords-text');
        var socket = io(`${window.location.protocol}//${RELAY_HOST}:5000`);

        socket.on('connect', function(){
            statusDiv.classList.add("connected");
            statusDiv.classList.remove("disconnected");
            statusText.innerHTML = "Connected to Server";
            console.log('Connected to Flask Socket.IO');
        });
        
        socket.on('disconnect', function(){
            statusDiv.classList.remove("connected");
            statusDiv.classList.add("disconnected");
            statusText.innerHTML = "Disconnect to Server!";
            console.log('Disconnected from Flask Socket.IO');
        });

        socket.on('connect_error', function(error){
            console.error('Socket.IO connection error:', error);
            statusDiv.classList.remove("connected");
            statusDiv.classList.add("disconnected");
            statusText.innerHTML = "Connection Error!";
        });

        const wrtcModal  = document.getElementById('webrtc-modal');
        const wrtcCanvas = document.getElementById('wrtc-canvas');
        const wrtcClose  = document.getElementById('close-wrtc');
        const loadingOverlay = document.getElementById('loading-overlay');
        let wrtcPlayer = null;

        function openWebRTC(camId) {
            console.log('Opening WebRTC for camera:', camId);
            
            if (wrtcPlayer && wrtcPlayer.destroy) {
                try { 
                    wrtcPlayer.destroy(); 
                    console.log('Previous player destroyed');
                } catch(e) {
                    console.error('Error destroying player:', e);
                }
            }
            wrtcPlayer = null;
            wrtcModal.style.display = 'flex';
            loadingOverlay.style.display = 'flex';

            if (typeof window.loadPlayer !== 'function') {
                loadingOverlay.innerHTML = 'Error: Server camera not ready';
                console.error('loadPlayer function not available');
                return;
            }

            const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const url = `${wsProtocol}${RELAY_HOST}:${RELAY_PORT}/api/stream/${camId}`;
            
            console.log('Connecting to:', url);

            try {
                wrtcPlayer = loadPlayer({ 
                    url: url, 
                    canvas: wrtcCanvas, 
                    audio: false,
                    onDisconnect: () => {
                        console.log('WebRTC disconnected');
                        loadingOverlay.style.display = 'flex';
                        loadingOverlay.innerHTML = 'Disconnect to camera ';
                    }
                });
                
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 2000);
                
            } catch(e) {
                console.error('Error loading player:', e);
                loadingOverlay.innerHTML = 'Error connecting: ' + e.message;
            }
        }

        wrtcClose.onclick = () => {
            console.log('Closing WebRTC modal');
            if (wrtcPlayer && wrtcPlayer.destroy) {
                try { 
                    wrtcPlayer.destroy(); 
                } catch(e) {
                    console.error('Error destroying player:', e);
                }
            }
            wrtcModal.style.display = 'none';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.innerHTML = 'Loading camera...';
        };

        function bindMarkerForCamera(marker, camId) {
            marker.on('click', () => {
                console.log('Marker clicked, opening camera:', camId);
                openWebRTC(camId);
            });
        }

        socket.on('gps_update', function(data){
            var lat = data.lat, lon = data.lon;
            console.log('GPS Update:', lat, lon);

            if (!marker) {
                marker = L.marker([lat, lon], {icon: xeIcon}).addTo(map)
                    .bindPopup('üìç Current location<br><small>Click to live camera </small>')
                    .openPopup();
                bindMarkerForCamera(marker, 'cam1');
                if (autoFollow) map.setView([lat, lon], 16);
            } else {
                marker.setLatLng([lat, lon]);
                if (autoFollow) map.setView([lat, lon], 16);
            }

            latlngs.push([lat, lon]);
            if (polyline) {
                polyline.setLatLngs(latlngs);
            } else {
                polyline = L.polyline(latlngs, {color: '#3175c3', weight: 4}).addTo(map);
            }

            var now = new Date();
            var strTime = now.toLocaleString('vi-VN');
            updateText.innerText = "Latest Updated: " + strTime;
            coordsText.innerText = `Lat: ${lat.toFixed(6)} | Lon: ${lon.toFixed(6)}`;
        });

        document.getElementById('clear-history').onclick = function() {
            latlngs = [];
            if(polyline) polyline.setLatLngs([]);
            console.log('History cleared');
        };

        var followBtn = document.getElementById('follow-marker');
        followBtn.onclick = function() {
            autoFollow = true;
            followBtn.classList.add("active");
            if (marker) map.setView(marker.getLatLng(), 16);
            console.log('Auto-follow enabled');
        };
        
        map.on('movestart', function() {
            autoFollow = false;
            followBtn.classList.remove("active");
        });

        window.addEventListener('load', function() {
            console.log('=== GPS Tracking Page Loaded ===');
            console.log('Flask Server:', `${window.location.protocol}//${RELAY_HOST}:5000`);
            console.log('Camera Server:', `${window.location.protocol}//${RELAY_HOST}:${RELAY_PORT}`);
            console.log('rtsp-relay.js:', scriptSrc);
        });
    </script>
</body>
</html>